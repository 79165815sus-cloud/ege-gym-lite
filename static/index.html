<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>–ö–∞—á–∞–ª–∫–∞</title>
  <style>
    :root {
      color-scheme: light;
      --bg: #f5f3ff;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --primary: #7c3aed;
      --primary-hover: #6d28d9;
      --accent: #4c1d95;
      --ok: #16a34a;
      --bad: #b91c1c;
      --border: #e5e7eb;
      --shadow: 0 16px 32px rgba(15, 23, 42, 0.12);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, Arial, sans-serif;
      background-color: var(--bg);
      background-image:
        linear-gradient(rgba(245, 243, 255, 0.92), rgba(245, 243, 255, 0.92)),
        url("/bg.jpg");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      color: var(--text);
    }

    .page {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 32px 16px;
    }

    .card {
      width: 100%;
      max-width: 640px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 28px;
      position: relative;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 6px;
    }

    .brand-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filters-link {
      font-size: 12px;
      color: var(--accent);
      text-decoration: none;
      padding: 6px 10px;
      border: 1px solid #e9d5ff;
      border-radius: 10px;
      background: #f5f3ff;
      transition: background 0.15s ease, border-color 0.15s ease;
      white-space: nowrap;
    }

    .filters-link:hover {
      background: #ede9fe;
      border-color: #ddd6fe;
    }

    .badge {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: var(--primary);
      color: #fff;
      font-weight: 800;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 20px rgba(124, 58, 237, 0.3);
      letter-spacing: -0.02em;
    }

    h1 {
      margin: 0 0 8px;
      font-size: 28px;
      letter-spacing: -0.01em;
    }

    .subtitle {
      margin: 0 0 20px;
      color: var(--muted);
      font-size: 14px;
    }

    .meta {
      margin: 0 0 8px;
      color: var(--accent);
      font-size: 12px;
      letter-spacing: 0.02em;
    }

    .plan {
      margin: 0 0 12px;
      font-size: 12px;
      color: var(--muted);
    }


    .chain {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 0 0 16px;
      flex-wrap: wrap;
    }

    .chain-item {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid #ddd6fe;
      background: #f5f3ff;
      color: var(--accent);
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
    }

    .chain-item.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    .chain-item.done {
      background: #ede9fe;
      color: #4c1d95;
      border-color: #c4b5fd;
    }

    .chain-line {
      width: 18px;
      height: 2px;
      background: #ddd6fe;
      border-radius: 2px;
    }

    .question {
      margin: 0 0 16px;
      padding: 14px 16px;
      background: #f5f3ff;
      border: 1px solid #ddd6fe;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 500;
      text-indent: 24px;
      line-height: 1.5;
      white-space: pre-wrap;
    }

    .question-image {
      width: 100%;
      max-height: 260px;
      object-fit: contain;
      border-radius: 12px;
      border: 1px solid #e9d5ff;
      margin: 0 0 16px;
      background: #fff;
    }

    .part-block {
      margin: 0 0 16px;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid #e9d5ff;
      background: #faf7ff;
      display: grid;
      gap: 10px;
    }

    .part-title {
      font-size: 12px;
      color: var(--accent);
      letter-spacing: 0.02em;
    }

    .upload-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .upload-row .actions-right {
      margin-left: auto;
      display: inline-flex;
      gap: 8px;
      align-items: center;
    }

    .file-input {
      display: none;
    }

    .file-label {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid #ddd6fe;
      background: #f5f3ff;
      color: var(--accent);
      font-size: 12px;
      cursor: pointer;
      white-space: nowrap;
    }

    .file-name {
      font-size: 12px;
      color: var(--muted);
    }

    .part-preview {
      width: 100%;
      max-height: 240px;
      object-fit: contain;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fff;
    }

    .score-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      font-size: 12px;
      color: var(--muted);
    }

    .score-row .actions-right {
      margin-left: auto;
      display: inline-flex;
      gap: 8px;
      align-items: center;
    }

    .score-row input[type="number"] {
      width: 90px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 12px;
    }

    .score-status {
      color: var(--accent);
      font-size: 12px;
    }

    .answer-controls {
      display: flex;
      gap: 10px;
      flex: 1 1 auto;
      flex-wrap: wrap;
      align-items: center;
    }

    .part-frame {
      border: 1px solid #e9d5ff;
      background: #fff;
      border-radius: 10px;
      padding: 10px;
    }

    .row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    input[type="number"] {
      flex: 1 1 140px;
      min-width: 140px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 16px;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
      background: #fff;
    }

    input[type="number"]:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.18);
    }


    .btn {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fff;
      cursor: pointer;
      font-size: 14px;
      transition: transform 0.05s ease, background 0.15s ease, border-color 0.15s ease, color 0.15s ease;
    }

    .btn:hover { background: #f8fafc; }
    .btn:active { transform: translateY(1px); }

    .btn-primary {
      background: var(--primary);
      border-color: var(--primary);
      color: #fff;
    }
    .btn-primary:hover { background: var(--primary-hover); }

    .btn-ghost {
      background: transparent;
      border-color: var(--accent);
      color: var(--accent);
    }
    .btn-ghost:hover { background: #f5f3ff; }

    .btn-next {
      margin-top: 0;
    }

    .second-part-active .btn-next {
      margin-top: 12px;
    }

    .btn-soft {
      background: #f5f3ff;
      border-color: #e9d5ff;
      color: var(--accent);
    }
    .btn-soft:hover { background: #ede9fe; }

    .btn-contrast {
      background: var(--primary);
      border-color: var(--primary);
      color: #fff;
    }
    .btn-contrast:hover { background: var(--primary-hover); }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .hidden {
      display: none !important;
    }

    .auth-link {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: 1px solid #e9d5ff;
      background: #f5f3ff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: var(--accent);
      text-decoration: none;
      transition: background 0.15s ease, border-color 0.15s ease;
    }

    .auth-link:hover {
      background: #ede9fe;
      border-color: #ddd6fe;
    }

    .auth-link svg {
      width: 18px;
      height: 18px;
      display: block;
    }

    .services-menu {
      position: relative;
    }

    .services-button {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: 1px solid #e9d5ff;
      background: #f5f3ff;
      color: var(--accent);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .services-list {
      position: absolute;
      top: 44px;
      right: 0;
      min-width: 160px;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 6px;
      display: none;
      gap: 4px;
      z-index: 30;
    }

    .services-menu:hover .services-list,
    .services-menu:focus-within .services-list {
      display: grid;
    }

    .services-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 8px;
      color: var(--accent);
      text-decoration: none;
      font-size: 14px;
    }

    .services-item:hover {
      background: #f5f3ff;
    }
    .menu {
      display: flex;
      justify-content: flex-end;
      margin: 8px 0 12px;
      position: relative;
    }

    .menu-button {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: 1px solid #e9d5ff;
      background: #fff;
      cursor: pointer;
      font-size: 20px;
      line-height: 1;
      color: var(--accent);
    }

    .menu-list {
      position: absolute;
      top: 44px;
      right: 0;
      min-width: 160px;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 6px;
      display: grid;
      gap: 4px;
    }

    .menu-item {
      padding: 8px 10px;
      border-radius: 8px;
      color: var(--accent);
      text-decoration: none;
      font-size: 14px;
    }

    .menu-item:hover {
      background: #f5f3ff;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 10;
    }

    .modal {
      width: 100%;
      max-width: 420px;
      background: #fff;
      border-radius: 16px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 20px;
      text-align: center;
    }

    .modal h2 {
      margin: 0 0 8px;
      font-size: 18px;
    }

    .modal p {
      margin: 0 0 16px;
      color: var(--muted);
      font-size: 14px;
    }

    .modal-illustration {
      width: 100%;
      max-width: 240px;
      height: auto;
      margin: 0 auto 12px;
      display: block;
      filter: drop-shadow(0 10px 18px rgba(124, 58, 237, 0.25));
    }

    .modal-title {
      color: var(--accent);
      font-weight: 700;
    }

    .result {
      margin: 12px 0 0;
      font-weight: 600;
    }

    .result.ok { color: var(--ok); }
    .result.bad { color: var(--bad); }

    .hint {
      margin: 6px 0 0;
      color: #5b4b8a;
      background: #f3e8ff;
      border: 1px solid #e9d5ff;
      padding: 8px 10px;
      border-radius: 10px;
    }

    .ai-blocks {
      margin: 8px 0 0;
      padding: 0 0 0 18px;
      color: #4a5568;
    }

    .divider {
      height: 1px;
      background: var(--border);
      margin: 16px 0;
    }

    .ai-tutor {
      margin-top: 16px;
      border: 1px solid #e9d5ff;
      background: #faf7ff;
      border-radius: 14px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .ai-tutor-title {
      font-weight: 700;
      color: var(--accent);
      margin: 0;
    }

    .ai-prompts {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .ai-input-row {
      display: flex;
      gap: 10px;
    }

    .ai-input-row input {
      flex: 1;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="card" id="taskCard">
      <div class="brand-header">
        <div class="brand">
          <div class="badge">100</div>
          <div>
            <h1>–ö–∞—á–∞–ª–∫–∞</h1>
            <p class="subtitle">¬´–í–∏–∂—É —Ü–µ–ª—å ‚Äî –Ω–µ –≤–∏–∂—É –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π¬ª ‚Äî –î–∂–µ–π—Å–æ–Ω –°—Ç–µ—Ç—Ö–µ–º</p>
          </div>
        </div>
        <div class="header-actions">
          <a class="filters-link" href="/filters.html" id="resetLink">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</a>
          <div class="services-menu">
            <button class="services-button" type="button" aria-label="–°–µ—Ä–≤–∏—Å—ã">
              <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                <rect x="4" y="4" width="6" height="6" rx="2" fill="currentColor"></rect>
                <rect x="14" y="4" width="6" height="6" rx="2" fill="currentColor"></rect>
                <rect x="4" y="14" width="6" height="6" rx="2" fill="currentColor"></rect>
                <rect x="14" y="14" width="6" height="6" rx="2" fill="currentColor"></rect>
              </svg>
            </button>
            <div class="services-list">
              <a class="services-item" href="https://100points.ru/wiki/" target="_blank" rel="noopener noreferrer">üìò –£—á–µ–±–Ω–∏–∫</a>
              <a class="services-item" href="https://100points.ru/wiki/tips-and-tricks/" target="_blank" rel="noopener noreferrer">‚ñ∂Ô∏è –ú–µ–¥–∏–∞</a>
              <a class="services-item" href="/home.html">üè† –ì–ª–∞–≤–Ω–∞—è</a>
              <a class="services-item" href="/filters.html">üèãÔ∏è –ö–∞—á–∞–ª–∫–∞</a>
              <a class="services-item" href="/navigator.html">üß≠ –ù–∞–≤–∏–≥–∞—Ç–æ—Ä –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è</a>
              <a class="services-item" href="/proorientation.html">üéØ –ü—Ä–æ—Ñ–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è</a>
              <a class="services-item" href="https://100points.ru/courses/" target="_blank" rel="noopener noreferrer">üõçÔ∏è –ú–∞–≥–∞–∑–∏–Ω</a>
            </div>
          </div>
          <a id="authLink" class="auth-link" href="/login.html" aria-label="–í–æ–π—Ç–∏ –∏–ª–∏ –∫–∞–±–∏–Ω–µ—Ç">
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2c-4 0-7 2.2-7 5v1h14v-1c0-2.8-3-5-7-5Z" fill="currentColor"></path>
            </svg>
          </a>
        </div>
      </div>

      <p id="meta" class="meta"></p>
      <div class="menu">
        <button id="menuButton" class="menu-button" type="button">‚ãØ</button>
        <div id="menuList" class="menu-list hidden">
          <a class="menu-item" href="#" id="shareLink">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</a>
          <a class="menu-item" href="mailto:support@100points.ru?subject=–°–æ–æ–±—â–∏—Ç—å%20–æ–±%20–æ—à–∏–±–∫–µ&body=–û–ø–∏—à–∏—Ç–µ%20–ø—Ä–æ–±–ª–µ–º—É%20–∏%20—É–∫–∞–∂–∏—Ç–µ%20—Å—Å—ã–ª–∫—É:" id="reportLink">–°–æ–æ–±—â–∏—Ç—å –æ–± –æ—à–∏–±–∫–µ</a>
        </div>
      </div>
      <p id="planInfo" class="plan"></p>
      <p id="question" class="question">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
      <img id="questionImage" class="question-image hidden" alt="–ò–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è –∫ –∑–∞–¥–∞–Ω–∏—é">

      <div id="secondPartBlock" class="part-block hidden">
        <div class="part-title">–ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ ‚Äì –ø—Ä–∏–ª–æ–∂–∏—Ç–µ —Ä–µ—à–µ–Ω–∏–µ</div>
        <div class="upload-row">
          <input id="solutionImage" class="file-input" type="file" accept="image/*">
          <label class="file-label" for="solutionImage">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</label>
          <span id="solutionFileName" class="file-name">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</span>
          <span class="actions-right">
            <button class="btn btn-contrast" id="checkSecond" type="button">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
            <button class="btn btn-contrast" id="clearImage" type="button">–û—á–∏—Å—Ç–∏—Ç—å</button>
          </span>
        </div>
        <img id="solutionPreview" class="part-preview hidden" alt="–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ">
        <p id="secondFeedback" class="hint hidden"></p>
        <ul id="secondFeedbackBlocks" class="ai-blocks hidden"></ul>
      </div>

      <div id="secondPartScoreBlock" class="part-frame hidden">
        <div class="part-title">–°–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∞</div>
        <div class="score-row">
          <span id="secondScoreLabel">–ë–∞–ª–ª—ã (0‚Äì4)</span>
          <input id="manualScore" type="number" min="0" max="4" step="1" placeholder="0">
          <span class="actions-right">
            <button class="btn btn-soft" id="secondSolution" type="button">–†–µ—à–µ–Ω–∏–µ</button>
            <button class="btn btn-soft" id="saveScore" type="button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </span>
          <span id="scoreStatus" class="score-status"></span>
        </div>
      </div>

      <div class="row">
        <div id="answerControls" class="answer-controls">
          <input id="answer" type="number" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç"/>
          <button class="btn btn-primary" onclick="check()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
        </div>
        <button class="btn btn-ghost btn-next" onclick="load()">–°–ª–µ–¥—É—é—â–∞—è</button>
      </div>

      <div id="answerRow" class="row">
        <button id="answerButton" class="btn btn-soft" onclick="showAnswer()">–û—Ç–≤–µ—Ç</button>
        <button class="btn btn-soft hidden" id="solutionButton" onclick="showSolution()">–†–µ—à–µ–Ω–∏–µ</button>
      </div>

      <div id="chain" class="chain"></div>

      <div class="divider"></div>

      <p id="result" class="result"></p>
      <p id="answerText" class="hint hidden"></p>
      <p id="solutionText" class="hint hidden"></p>

      <div class="ai-tutor">
        <div class="ai-tutor-title">–†–µ–ø–µ—Ç–∏—Ç–æ—Ä AI</div>
        <div class="ai-prompts">
          <button class="btn btn-soft" type="button" data-ai-prompt="–û–±—ä—è—Å–Ω–∏ —Ç–µ–æ—Ä–∏—é –ø–æ —Ç–µ–º–µ —ç—Ç–æ–π –∑–∞–¥–∞—á–∏.">–û–±—ä—è—Å–Ω–∏ —Ç–µ–æ—Ä–∏—é</button>
          <button class="btn btn-soft" type="button" data-ai-prompt="–ü–æ–¥—Å–∫–∞–∂–∏ —Ä–µ—à–µ–Ω–∏–µ –ø–æ—à–∞–≥–æ–≤–æ, –±–µ–∑ –≥–æ—Ç–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞.">–ü–æ–¥—Å–∫–∞–∂–∏ —Ä–µ—à–µ–Ω–∏–µ</button>
        </div>
        <div class="ai-input-row">
          <input id="aiTutorInput" type="text" placeholder="–ù–∞–ø–∏—à–∏ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ —É—Ç–æ—á–Ω–µ–Ω–∏–µ..." />
          <button class="btn btn-soft" type="button" id="aiTutorSend">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <div id="resetModal" class="modal-backdrop hidden">
    <div class="modal">
      <h2 class="modal-title">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ?</h2>
      <p>–í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è.</p>
      <div class="row" style="justify-content: center; margin-bottom: 0;">
        <button class="btn btn-ghost" id="resetCancel" type="button">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn btn-primary" id="resetConfirm" type="button">–î–∞, –Ω–∞—á–∞—Ç—å</button>
      </div>
    </div>
  </div>


  <script>
    window.MathJax = {
      tex: { inlineMath: [['\\(', '\\)'], ['$', '$']] },
      svg: { fontCache: 'global' }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
  <script>
    let currentTask;
    let remainingCount = null;
    let totalCount = null;
    let currentIndex = null;
    let hasTriedAnswer = false;
    let giftShown = false;
    let completedCount = 0;
    let hasLoadedOnce = false;
    let sequenceTasks = null;
    const anonId = getAnonId();
    const secondPartBlock = document.getElementById("secondPartBlock");
    const solutionImageInput = document.getElementById("solutionImage");
    const solutionPreview = document.getElementById("solutionPreview");
    const clearImageButton = document.getElementById("clearImage");
    const checkSecondButton = document.getElementById("checkSecond");
    const solutionFileName = document.getElementById("solutionFileName");
    const secondFeedback = document.getElementById("secondFeedback");
    const secondFeedbackBlocks = document.getElementById("secondFeedbackBlocks");
    const secondSolutionButton = document.getElementById("secondSolution");
    const manualScoreInput = document.getElementById("manualScore");
    const saveScoreButton = document.getElementById("saveScore");
    const scoreStatus = document.getElementById("scoreStatus");
    const secondPartScoreBlock = document.getElementById("secondPartScoreBlock");
    const answerControls = document.getElementById("answerControls");
    const answerRow = document.getElementById("answerRow");
    const answerButton = document.getElementById("answerButton");
    const taskCard = document.getElementById("taskCard");
    const aiTutorInput = document.getElementById("aiTutorInput");
    const aiTutorSend = document.getElementById("aiTutorSend");
    const aiPromptButtons = document.querySelectorAll("[data-ai-prompt]");

    async function load() {
      const params = new URLSearchParams(window.location.search);
      const rawCount = params.get("count");
      const sequence = params.get("sequence") === "1";
      const errorsMode = params.get("mode") === "errors";
      const startIndexParam = params.get("startIndex");
      if (remainingCount === null && rawCount && !sequence && !errorsMode) {
        const parsed = Number(rawCount);
        totalCount = Number.isFinite(parsed) && parsed > 0 ? parsed : null;
        remainingCount = totalCount;
      }
      if (totalCount && startIndexParam && currentIndex === null) {
        const startIndex = Number(startIndexParam);
        if (Number.isFinite(startIndex) && startIndex >= 1 && startIndex <= totalCount) {
          currentIndex = startIndex;
          remainingCount = totalCount - startIndex + 1;
        }
      }

      if (hasLoadedOnce) {
        completedCount += 1;
      }
      hasLoadedOnce = true;
      if (!giftShown && completedCount >= 5) {
        showGift();
      }

      if (remainingCount !== null && remainingCount <= 0) {
        if (errorsMode) {
          window.location.href = "/filters.html";
          return;
        }
        if (!giftShown) showGift();
        return;
      }

      if (errorsMode) {
        const allMistakes = readMistakeTasks();
        const filteredMistakes = filterMistakeTasks(allMistakes, params);
        filteredMistakes.sort((a, b) => {
          if (a.examTaskNumber !== b.examTaskNumber) {
            return (a.examTaskNumber || 0) - (b.examTaskNumber || 0);
          }
          return a.id - b.id;
        });
        sequenceTasks = filteredMistakes;
        if (sequenceTasks.length === 0) {
          showErrorsEmptyState();
          return;
        }
        totalCount = sequenceTasks.length;
        if (remainingCount === null || remainingCount > totalCount) {
          remainingCount = totalCount;
        }
        currentIndex = totalCount - remainingCount + 1;
        const index = Math.min(Math.max(currentIndex - 1, 0), sequenceTasks.length - 1);
        currentTask = sequenceTasks[index];
      } else if (sequence) {
        if (!sequenceTasks) {
          const listParams = new URLSearchParams(params.toString());
          listParams.delete("count");
          listParams.delete("sequence");
          const listUrl = listParams.toString() ? "/api/tasks-public?" + listParams.toString() : "/api/tasks-public";
          const listRes = await fetch(listUrl);
          if (!listRes.ok) {
            document.getElementById("question").innerText = "–ù–µ—Ç –∑–∞–¥–∞—á –ø–æ–¥ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã.";
            document.getElementById("meta").innerText = "";
            document.getElementById("planInfo").innerText = "";
            return;
          }
          sequenceTasks = await listRes.json();
        }
        totalCount = sequenceTasks.length;
        if (remainingCount === null || remainingCount > totalCount) {
          remainingCount = totalCount;
        }
        currentIndex = totalCount - remainingCount + 1;
        const index = Math.min(Math.max(currentIndex - 1, 0), sequenceTasks.length - 1);
        currentTask = sequenceTasks[index];
      } else {
        const url = params.toString() ? "/api/task?" + params.toString() : "/api/task";
        const res = await fetch(url);
        if (!res.ok) {
          document.getElementById("question").innerText = "–ù–µ—Ç –∑–∞–¥–∞—á –ø–æ–¥ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã.";
          document.getElementById("meta").innerText = "";
          document.getElementById("planInfo").innerText = "";
          return;
        }
        currentTask = await res.json();
      }

      if (!currentTask) {
        document.getElementById("question").innerText = "–ù–µ—Ç –∑–∞–¥–∞—á –ø–æ–¥ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã.";
        document.getElementById("meta").innerText = "";
        document.getElementById("planInfo").innerText = "";
        return;
      }
      trackEvent("task_view", {
        task_id: currentTask.id,
        subject: currentTask.subject,
        exam_type: currentTask.examType,
        exam_task_number: currentTask.examTaskNumber
      });
      const metaParts = [];
      if (currentTask.subject) metaParts.push(currentTask.subject);
      if (currentTask.examType) metaParts.push(currentTask.examType);
      if (Number.isFinite(currentTask.examTaskNumber)) {
        metaParts.push("‚Ññ" + currentTask.examTaskNumber);
      }
      if (currentTask.subtopic) metaParts.push(currentTask.subtopic);
      document.getElementById("meta").innerText = metaParts.join(" ¬∑ ");
      if (remainingCount !== null && totalCount !== null) {
        if (currentIndex === null) {
          currentIndex = totalCount - remainingCount + 1;
        }
        const remainingAfter = Math.max(remainingCount - 1, 0);
        document.getElementById("planInfo").innerText =
          "–ó–∞–¥–∞–Ω–∏–µ " + currentIndex + " –∏–∑ " + totalCount +
          " ¬∑ –û—Å—Ç–∞–ª–æ—Å—å: " + remainingAfter;
        renderChain(totalCount, currentIndex);
      } else {
        document.getElementById("planInfo").innerText = "";
        document.getElementById("chain").innerHTML = "";
      }
      setMathText(document.getElementById("question"), currentTask.question);
      const questionImage = document.getElementById("questionImage");
      if (currentTask.imageUrl) {
        questionImage.src = currentTask.imageUrl;
        questionImage.classList.remove("hidden");
      } else {
        questionImage.classList.add("hidden");
        questionImage.removeAttribute("src");
      }
      document.getElementById("result").innerText = "";
      setMathText(document.getElementById("answerText"), "");
      setMathText(document.getElementById("solutionText"), "");
      document.getElementById("answerText").classList.add("hidden");
      document.getElementById("solutionText").classList.add("hidden");
      document.getElementById("answer").value = "";
      hasTriedAnswer = false;
      document.getElementById("solutionButton").classList.add("hidden");
      updatePartUI(currentTask);

      if (remainingCount !== null) {
        remainingCount -= 1;
      }
    }

    async function check() {
      const answer = document.getElementById("answer").value.trim();
      const resultEl = document.getElementById("result");
      if (!answer) {
        resultEl.innerText = "–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç –ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–æ–π.";
        resultEl.classList.remove("ok");
        resultEl.classList.add("bad");
        return;
      }
      hasTriedAnswer = true;
      document.getElementById("solutionButton").classList.remove("hidden");
      recordAttempt();
      trackEvent("check_answer", { task_id: currentTask.id });
      const res = await fetch("/api/check", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ id: currentTask.id, answer })
      });
      const data = await res.json();
      resultEl.innerText = data.correct ? "‚úÖ –í–µ—Ä–Ω–æ" : "‚ùå –ù–µ–≤–µ—Ä–Ω–æ";
      resultEl.classList.toggle("ok", data.correct);
      resultEl.classList.toggle("bad", !data.correct);
      if (data.correct) {
        if (isErrorsMode()) {
          removeMistakeTask(currentTask.id);
        }
      } else {
        addMistakeTask(currentTask);
      }
    }

    function renderChain(total, current) {
      const chain = document.getElementById("chain");
      chain.innerHTML = "";
      for (let i = 1; i <= total; i += 1) {
        const item = document.createElement("button");
        item.type = "button";
        item.className = "chain-item";
        if (i < current) item.classList.add("done");
        if (i === current) item.classList.add("active");
        item.textContent = String(i);
        item.addEventListener("click", () => jumpTo(i));
        chain.appendChild(item);
        if (i < total) {
          const line = document.createElement("div");
          line.className = "chain-line";
          chain.appendChild(line);
        }
      }
    }

    function jumpTo(targetIndex) {
      if (totalCount === null || remainingCount === null) return;
      if (targetIndex < 1 || targetIndex > totalCount) return;
      currentIndex = targetIndex;
      remainingCount = totalCount - targetIndex + 1;
    load();
    }



    async function showAnswer() {
      const res = await fetch("/api/answer", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ id: currentTask.id })
      });
      const data = await res.json();
      setMathText(document.getElementById("answerText"), "–û—Ç–≤–µ—Ç: " + data.answer);
      trackEvent("show_answer", { task_id: currentTask.id });
      document.getElementById("answerText").classList.remove("hidden");
    }

    async function showSolution() {
      if (!hasTriedAnswer && !isSecondPartTask(currentTask)) return;
      const res = await fetch("/api/solution", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ id: currentTask.id })
      });
      const data = await res.json();
      setMathText(document.getElementById("solutionText"), "–†–µ—à–µ–Ω–∏–µ: " + data.solution);
      trackEvent("show_solution", { task_id: currentTask.id });
      document.getElementById("solutionText").classList.remove("hidden");
    }

    const menuButton = document.getElementById("menuButton");
    const menuList = document.getElementById("menuList");
    menuButton.addEventListener("click", () => {
      menuList.classList.toggle("hidden");
    });
    document.addEventListener("click", (event) => {
      if (!menuList.classList.contains("hidden") && !menuButton.contains(event.target) && !menuList.contains(event.target)) {
        menuList.classList.add("hidden");
      }
    });

    document.getElementById("shareLink").addEventListener("click", async (event) => {
      event.preventDefault();
      const url = window.location.href;
      if (navigator.share) {
        try {
          await navigator.share({ title: "–ö–∞—á–∞–ª–∫–∞", url });
          return;
        } catch (error) {
          // ignore
        }
      }
      navigator.clipboard.writeText(url);
      alert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞");
    });

    async function loadAuthStatus() {
      const link = document.getElementById("authLink");
      const res = await fetch("/api/me");
      if (!res.ok) {
        link.href = "/login.html";
        link.setAttribute("aria-label", "–í–æ–π—Ç–∏");
        return;
      }
      link.href = "/cabinet.html";
      link.setAttribute("aria-label", "–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç");
    }


    function recordAttempt() {
      if (!currentTask || !currentTask.subject) return;
      const key = "taskAttempts";
      const payload = {
        subject: currentTask.subject,
        timestamp: Date.now()
      };
      const existing = JSON.parse(localStorage.getItem(key) || "[]");
      existing.push(payload);
      localStorage.setItem(key, JSON.stringify(existing));
    }

    const mistakeStorageKey = "mistakeTasks";

    function readMistakeTasks() {
      try {
        const stored = JSON.parse(localStorage.getItem(mistakeStorageKey) || "[]");
        return Array.isArray(stored) ? stored : [];
      } catch (error) {
        return [];
      }
    }

    function writeMistakeTasks(tasks) {
      localStorage.setItem(mistakeStorageKey, JSON.stringify(tasks));
    }

    function addMistakeTask(task) {
      if (!task || !Number.isFinite(task.id)) return;
      const existing = readMistakeTasks();
      if (existing.some((item) => item.id === task.id)) return;
      existing.push({
        id: task.id,
        question: task.question || "",
        imageUrl: task.imageUrl || "",
        subject: task.subject || "",
        examTaskNumber: Number.isFinite(task.examTaskNumber) ? task.examTaskNumber : null,
        subtopic: task.subtopic || "",
        examType: task.examType || ""
      });
      writeMistakeTasks(existing);
    }

    function removeMistakeTask(taskId) {
      const existing = readMistakeTasks();
      const filtered = existing.filter((item) => item.id !== taskId);
      writeMistakeTasks(filtered);
    }

    function isErrorsMode() {
      const params = new URLSearchParams(window.location.search);
      return params.get("mode") === "errors";
    }

    function filterMistakeTasks(items, params) {
      const examType = params.get("examType");
      const subject = params.get("subject");
      const subtopic = params.get("subtopic");
      const rawExamTaskNumber = params.get("examTaskNumber");
      const examTaskNumber = rawExamTaskNumber ? Number(rawExamTaskNumber) : null;
      return items.filter((task) => {
        if (examType && task.examType !== examType) return false;
        if (subject && task.subject !== subject) return false;
        if (subtopic && task.subtopic !== subtopic) return false;
        if (Number.isFinite(examTaskNumber) && task.examTaskNumber !== examTaskNumber) return false;
        return true;
      });
    }

    function showErrorsEmptyState() {
      document.getElementById("question").innerText = "–ù–µ—Ç –∑–∞–¥–∞–Ω–∏–π –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ—à–∏–±–∫–∞–º–∏.";
      document.getElementById("meta").innerText = "";
      document.getElementById("planInfo").innerText = "";
      document.getElementById("chain").innerHTML = "";
    }

    function setMathText(element, text) {
      element.textContent = text || "";
      if (window.MathJax && window.MathJax.typesetPromise) {
        window.MathJax.typesetPromise([element]);
      }
    }

    function getAnonId() {
      const key = "anon_id";
      let value = localStorage.getItem(key);
      if (!value) {
        value = crypto.randomUUID();
        localStorage.setItem(key, value);
      }
      return value;
    }

    function trackEvent(event, properties) {
      fetch("/api/track", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          anon_id: anonId,
          event,
          properties: properties || {},
          path: window.location.pathname
        })
      }).catch(() => {});
    }
    function showGift() {
      giftShown = true;
      sessionStorage.setItem("lastQuizUrl", window.location.href);
      if (currentIndex !== null) {
        sessionStorage.setItem("nextQuizIndex", String(currentIndex));
      }
      trackEvent("show_gift", { task_index: currentIndex });
      const target = "/gift.html?from=" + encodeURIComponent(window.location.href);
      window.location.href = target;
    }

    document.getElementById("answer").addEventListener("keydown", (event) => {
      if (event.key === "Enter") check();
    });

    function isSecondPartTask(task) {
      if (!task) return false;
      const subject = String(task.subject || "").toLowerCase();
      const number = Number(task.examTaskNumber || 0);
      return subject === "–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –ø—Ä–æ—Ñ–∏–ª—å" && number >= 13;
    }

    function maxScoreForTask(task) {
      const number = Number(task?.examTaskNumber || 0);
      if (number >= 13 && number <= 15) return 2;
      if (number >= 16 && number <= 19) return 3;
      return 0;
    }

    function updatePartUI(task) {
      if (answerControls) {
        answerControls.classList.remove("hidden");
      }
      if (answerRow) {
        answerRow.classList.remove("hidden");
      }
      if (answerButton) {
        answerButton.classList.remove("hidden");
      }
      if (secondPartBlock) {
        secondPartBlock.classList.add("hidden");
      }

      if (isSecondPartTask(task)) {
        if (answerControls) answerControls.classList.add("hidden");
        if (answerRow) answerRow.classList.add("hidden");
        if (secondPartBlock) secondPartBlock.classList.remove("hidden");
        if (secondPartScoreBlock) secondPartScoreBlock.classList.remove("hidden");
        if (taskCard) taskCard.classList.add("second-part-active");
      }

      if (isSecondPartTask(task) && secondPartBlock) {
        if (solutionPreview) {
          solutionPreview.classList.add("hidden");
          solutionPreview.removeAttribute("src");
        }
        if (solutionImageInput) {
          solutionImageInput.value = "";
        }
        if (secondFeedback) {
          secondFeedback.classList.add("hidden");
          secondFeedback.textContent = "";
        }
        if (secondFeedbackBlocks) {
          secondFeedbackBlocks.classList.add("hidden");
          secondFeedbackBlocks.innerHTML = "";
        }
        if (manualScoreInput) {
          const maxScore = maxScoreForTask(task);
          manualScoreInput.max = String(maxScore);
          const scoreLabel = document.getElementById("secondScoreLabel");
          if (scoreLabel) {
            scoreLabel.textContent = "–ë–∞–ª–ª—ã (0‚Äì" + maxScore + ")";
          }
          const scores = JSON.parse(localStorage.getItem("manualScores") || "{}");
          const saved = scores[String(task.id)];
          manualScoreInput.value = Number.isFinite(saved) ? String(saved) : "";
        }
        if (scoreStatus) scoreStatus.textContent = "";
      }
      if (!isSecondPartTask(task) && secondPartScoreBlock) {
        secondPartScoreBlock.classList.add("hidden");
      }
      if (!isSecondPartTask(task) && taskCard) {
        taskCard.classList.remove("second-part-active");
      }

    }

    if (solutionImageInput && solutionPreview) {
      solutionImageInput.addEventListener("change", () => {
        const file = solutionImageInput.files && solutionImageInput.files[0];
        if (solutionFileName) {
          solutionFileName.textContent = file ? file.name : "–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω";
        }
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          solutionPreview.src = String(reader.result || "");
          solutionPreview.classList.remove("hidden");
        };
        reader.readAsDataURL(file);
      });
    }

    if (checkSecondButton && scoreStatus && manualScoreInput) {
      checkSecondButton.addEventListener("click", () => {
        const file = solutionImageInput && solutionImageInput.files
          ? solutionImageInput.files[0]
          : null;
        if (!file) {
          scoreStatus.textContent = "–°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–æ—Ç–æ —Ä–µ—à–µ–Ω–∏—è.";
          return;
        }
        const maxScore = maxScoreForTask(currentTask);
        let dots = 0;
        const baseText = "–ü—Ä–æ–≤–µ—Ä—è–µ–º";
        scoreStatus.textContent = baseText;
        checkSecondButton.disabled = true;
        const delay = 800 + Math.floor(Math.random() * 700);
        const intervalId = setInterval(() => {
          dots = (dots + 1) % 4;
          scoreStatus.textContent = baseText + ".".repeat(dots);
        }, 300);
        setTimeout(() => {
          clearInterval(intervalId);
          const score = Math.floor(Math.random() * (maxScore + 1));
          manualScoreInput.value = String(score);
          const scores = JSON.parse(localStorage.getItem("manualScores") || "{}");
          scores[String(currentTask?.id || "")] = score;
          localStorage.setItem("manualScores", JSON.stringify(scores));
          scoreStatus.textContent = "–ì–æ—Ç–æ–≤–æ: " + score + " –±–∞–ª–ª(–æ–≤)";
          const feedbackText =
            "AI-–∞–≥–µ–Ω—Ç —Ä–∞–∑–æ–±—Ä–∞–ª —Ä–µ—à–µ–Ω–∏–µ: –≤—ã–¥–µ–ª–∏–ª –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —à–∞–≥–∏ –∏ —É–∫–∞–∑–∞–ª, –≥–¥–µ –¥–æ–ø—É—â–µ–Ω—ã –æ—à–∏–±–∫–∏.";
          const blockTexts = [
            "–®–∞–≥ 1: –ø–µ—Ä–≤—ã–π –±–∞–ª–ª —Ç—ã –∑–∞–±—Ä–∞–ª –∏ –∞–±—Å–æ–ª—é—Ç–Ω–æ –ø—Ä–∞–≤.",
            "–®–∞–≥ 2: –≤–æ –≤—Ç–æ—Ä–æ–º —à–∞–≥–µ —Ç—ã —Å–æ–≤–µ—Ä—à–∏–ª –æ—à–∏–±–∫—É ‚Äî —Ç—É—Ç –∏ —Ç—É—Ç –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Ç–∞–∫ –∏ —Ç–∞–∫.",
            "–®–∞–≥ 3: —Ç—ã –ø—Ä–∏—à–µ–ª –∫ –Ω–µ–≤–µ—Ä–Ω–æ–º—É –≤—ã–≤–æ–¥—É ‚Äî –ø—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏–∫—É –ø–µ—Ä–µ—Ö–æ–¥–∞ –∏ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–π –∏—Ç–æ–≥.",
            "–ò—Ç–æ–≥: —á–∞—Å—Ç—å —Ä–µ—à–µ–Ω–∏—è –≤–µ—Ä–Ω–∞, –Ω–æ –µ—Å—Ç—å –æ—à–∏–±–∫–∏ –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ –∏ —Ñ–∏–Ω–∞–ª–µ.",
          ];
          if (secondFeedback) {
            secondFeedback.textContent = feedbackText;
            secondFeedback.classList.remove("hidden");
          } else {
            scoreStatus.textContent = scoreStatus.textContent + " ¬∑ " + feedbackText;
          }
          if (secondFeedbackBlocks) {
            secondFeedbackBlocks.innerHTML = "";
            blockTexts.forEach((text) => {
              const item = document.createElement("li");
              item.textContent = text;
              secondFeedbackBlocks.appendChild(item);
            });
            secondFeedbackBlocks.classList.remove("hidden");
          }
          checkSecondButton.disabled = false;
        }, delay);
      });
    }

    if (secondSolutionButton) {
      secondSolutionButton.addEventListener("click", () => {
        showSolution();
      });
    }

    if (clearImageButton && solutionPreview && solutionImageInput) {
      clearImageButton.addEventListener("click", () => {
        solutionImageInput.value = "";
        if (solutionFileName) solutionFileName.textContent = "–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω";
        solutionPreview.classList.add("hidden");
        solutionPreview.removeAttribute("src");
        if (secondFeedback) {
          secondFeedback.classList.add("hidden");
          secondFeedback.textContent = "";
        }
        if (secondFeedbackBlocks) {
          secondFeedbackBlocks.classList.add("hidden");
          secondFeedbackBlocks.innerHTML = "";
        }
      });
    }

    if (saveScoreButton && manualScoreInput && scoreStatus) {
      saveScoreButton.addEventListener("click", () => {
        const value = Number(manualScoreInput.value);
        const maxScore = maxScoreForTask(currentTask);
        if (!Number.isFinite(value) || value < 0 || value > maxScore) {
          scoreStatus.textContent = "–í–≤–µ–¥–∏—Ç–µ –±–∞–ª–ª—ã –æ—Ç 0 –¥–æ " + maxScore + ".";
          return;
        }
        const scores = JSON.parse(localStorage.getItem("manualScores") || "{}");
        scores[String(currentTask?.id || "")] = value;
        localStorage.setItem("manualScores", JSON.stringify(scores));
        scoreStatus.textContent = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ";
      });
    }


    const resetLink = document.getElementById("resetLink");
    const resetModal = document.getElementById("resetModal");
    const resetCancel = document.getElementById("resetCancel");
    const resetConfirm = document.getElementById("resetConfirm");
    if (resetLink && resetModal) {
      resetLink.addEventListener("click", (event) => {
        event.preventDefault();
        resetModal.classList.remove("hidden");
      });
    }
    if (resetCancel && resetModal) {
      resetCancel.addEventListener("click", () => {
        resetModal.classList.add("hidden");
      });
    }
    if (resetConfirm) {
      resetConfirm.addEventListener("click", () => {
        window.location.href = "/filters.html";
      });
    }
    if (resetModal) {
      resetModal.addEventListener("click", (event) => {
        if (event.target.id === "resetModal") resetModal.classList.add("hidden");
      });
    }

    trackEvent("page_view");
    loadAuthStatus();
    load();

    if (aiPromptButtons && aiTutorInput) {
      aiPromptButtons.forEach((button) => {
        button.addEventListener("click", () => {
          const prompt = button.getAttribute("data-ai-prompt") || "";
          aiTutorInput.value = prompt;
          aiTutorInput.focus();
        });
      });
    }

    function sendTutorMessage() {
      if (!aiTutorInput) return;
      const text = aiTutorInput.value.trim();
      if (!text) return;
      aiTutorInput.value = "";
    }

    if (aiTutorSend) {
      aiTutorSend.addEventListener("click", sendTutorMessage);
    }
    if (aiTutorInput) {
      aiTutorInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter") sendTutorMessage();
      });
    }
  </script>
</body>
</html>
