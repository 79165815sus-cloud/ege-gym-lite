<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Админка — Качалка</title>
  <style>
    :root {
      color-scheme: light;
      --bg: #f5f3ff;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --primary: #7c3aed;
      --primary-hover: #6d28d9;
      --accent: #4c1d95;
      --border: #e5e7eb;
      --shadow: 0 16px 32px rgba(15, 23, 42, 0.12);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, Arial, sans-serif;
      background-color: var(--bg);
      background-image:
        linear-gradient(rgba(245, 243, 255, 0.92), rgba(245, 243, 255, 0.92)),
        url("/bg.jpg");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      color: var(--text);
    }

    .page {
      min-height: 100vh;
      padding: 32px 16px;
    }

    .card {
      width: 100%;
      max-width: 1280px;
      margin: 0 auto;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 24px;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 16px;
    }

    h1 {
      margin: 0;
      font-size: 22px;
    }

    .links {
      display: flex;
      gap: 8px;
    }

    .link {
      font-size: 12px;
      color: var(--accent);
      text-decoration: none;
      padding: 6px 10px;
      border: 1px solid #e9d5ff;
      border-radius: 10px;
      background: #f5f3ff;
    }

    .toolbar {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fff;
      cursor: pointer;
      font-size: 13px;
    }

    .btn-primary {
      background: var(--primary);
      border-color: var(--primary);
      color: #fff;
    }
    .btn-primary:hover { background: var(--primary-hover); }

    .status {
      margin-left: auto;
      font-size: 12px;
      color: var(--muted);
    }

    .file-input {
      display: none;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    th, td {
      border: 1px solid var(--border);
      padding: 6px;
      vertical-align: top;
    }

    th {
      background: #fafafa;
      text-align: left;
      font-weight: 600;
    }

    .table-wrap {
      max-height: 70vh;
      overflow: auto;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #fff;
    }

    thead th {
      position: sticky;
      top: 0;
      z-index: 2;
    }

    thead tr:nth-child(2) th {
      top: 29px;
      z-index: 3;
      background: #f3f4f6;
    }

    input, textarea {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 6px 8px;
      font-size: 12px;
      font-family: inherit;
    }

    textarea {
      min-height: 90px;
      resize: vertical;
    }

    .row-actions {
      display: flex;
      justify-content: center;
    }

    .upload-wrap {
      display: grid;
      gap: 6px;
    }

    .upload-input {
      display: none;
    }

    .hidden {
      display: none !important;
    }

    .editor-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 30;
    }

    .editor-modal {
      width: 100%;
      max-width: 720px;
      background: #fff;
      border-radius: 16px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 16px;
      display: grid;
      gap: 10px;
    }

    .editor-modal textarea {
      min-height: 240px;
    }

    .editor-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="card">
      <div class="header">
        <h1>Админка заданий</h1>
        <div class="links">
          <a class="link" href="/admin-analytics.html">Аналитика</a>
          <a class="link" href="/filters.html">План</a>
          <a class="link" href="/">Качалка</a>
        </div>
      </div>

      <div class="toolbar">
        <button class="btn btn-primary" onclick="saveTasks()">Сохранить</button>
        <button class="btn" onclick="addTask()">Добавить</button>
        <button class="btn" onclick="document.getElementById('importFile').click()">Импорт</button>
        <button class="btn" onclick="loadTasks()">Обновить</button>
        <span id="status" class="status"></span>
      </div>
      <input id="importFile" class="file-input" type="file" accept="application/json">

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Вопрос</th>
              <th>Картинка</th>
              <th>Картинка решения</th>
              <th>Предмет</th>
              <th>№ в экзамене</th>
              <th>Вариант</th>
              <th>Подтема</th>
              <th>ЕГЭ/ОГЭ</th>
              <th>Ответ</th>
              <th>Решение</th>
              <th></th>
            </tr>
            <tr>
              <th><input id="filterId" placeholder="Фильтр"></th>
              <th><input id="filterQuestion" placeholder="Фильтр"></th>
              <th><input id="filterImage" placeholder="Фильтр"></th>
              <th><input id="filterSolutionImage" placeholder="Фильтр"></th>
              <th><input id="filterSubject" placeholder="Фильтр"></th>
              <th><input id="filterExamNumber" placeholder="Фильтр"></th>
              <th><input id="filterVariant" placeholder="Фильтр"></th>
              <th><input id="filterSubtopic" placeholder="Фильтр"></th>
              <th><input id="filterExamType" placeholder="Фильтр"></th>
              <th><input id="filterAnswer" placeholder="Фильтр"></th>
              <th><input id="filterSolution" placeholder="Фильтр"></th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tasksBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="editorBackdrop" class="editor-backdrop hidden">
    <div class="editor-modal">
      <strong id="editorTitle">Редактирование</strong>
      <textarea id="editorTextarea"></textarea>
      <div class="editor-actions">
        <button class="btn" id="editorCancel" type="button">Отмена</button>
        <button class="btn btn-primary" id="editorSave" type="button">Сохранить</button>
      </div>
    </div>
  </div>

  <script>
    let tasks = [];
    let subjectOptions = [];
    let activeEditorField = null;

    function setStatus(text) {
      document.getElementById("status").innerText = text || "";
    }

    async function loadTasks() {
      setStatus("Загрузка...");
      await loadSubjects();
      const res = await fetch("/api/tasks");
      if (!res.ok) {
        setStatus("Ошибка загрузки");
        return;
      }
      tasks = await res.json();
      renderTable();
      setStatus("Готово");
    }

    async function loadSubjects() {
      const res = await fetch("/api/filters");
      if (!res.ok) return;
      const data = await res.json();
      const baseSubjects = [
        "Математика профиль",
        "Математика база",
        "Русский язык",
        "Физика",
        "Информатика",
        "География",
        "Английский язык",
        "Литература",
        "Обществознание",
        "История",
        "Химия",
        "Биология"
      ];
      const fromApi = Array.isArray(data.subjects) ? data.subjects : [];
      subjectOptions = Array.from(new Set([...baseSubjects, ...fromApi]));
    }

    function renderTable() {
      const body = document.getElementById("tasksBody");
      body.innerHTML = "";
      const filtered = applyFilters(tasks);
      filtered.forEach((task) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td><input data-field="id" data-id="${task.id}" type="number" value="${task.id ?? ""}"></td>
          <td><textarea data-field="question" data-id="${task.id}">${task.question ?? ""}</textarea></td>
          <td>
            <div class="upload-wrap">
              <input data-field="imageUrl" data-id="${task.id}" value="${task.imageUrl ?? ""}">
              <button class="btn" type="button" onclick="triggerUpload(${task.id}, 'imageUrl')">Загрузить</button>
              <input class="upload-input" data-upload-id="${task.id}" data-upload-field="imageUrl" type="file" accept="image/*">
            </div>
          </td>
          <td>
            <div class="upload-wrap">
              <input data-field="solutionImageUrl" data-id="${task.id}" value="${task.solutionImageUrl ?? ""}">
              <button class="btn" type="button" onclick="triggerUpload(${task.id}, 'solutionImageUrl')">Загрузить</button>
              <input class="upload-input" data-upload-id="${task.id}" data-upload-field="solutionImageUrl" type="file" accept="image/*">
            </div>
          </td>
          <td>
            <select data-field="subject" data-id="${task.id}">
              ${renderSubjectOptions(task.subject)}
            </select>
          </td>
          <td><input data-field="examTaskNumber" data-id="${task.id}" type="number" value="${task.examTaskNumber ?? ""}"></td>
          <td><input data-field="variant" data-id="${task.id}" type="number" value="${task.variant ?? ""}"></td>
          <td><input data-field="subtopic" data-id="${task.id}" value="${task.subtopic ?? ""}"></td>
          <td><input data-field="examType" data-id="${task.id}" value="${task.examType ?? ""}"></td>
          <td><input data-field="answer" data-id="${task.id}" value="${task.answer ?? ""}"></td>
          <td><textarea data-field="solution" data-id="${task.id}">${task.solution ?? ""}</textarea></td>
          <td class="row-actions"><button class="btn" onclick="removeTask(${task.id})">Удалить</button></td>
        `;
        body.appendChild(row);
      });

      document.querySelectorAll("[data-upload-id]").forEach((input) => {
        input.addEventListener("change", handleUpload);
      });
      document.querySelectorAll("textarea[data-field]").forEach((textarea) => {
        textarea.addEventListener("dblclick", openEditor);
      });
    }

    function applyFilters(items) {
      const filters = {
        id: document.getElementById("filterId").value.trim().toLowerCase(),
        question: document.getElementById("filterQuestion").value.trim().toLowerCase(),
        imageUrl: document.getElementById("filterImage").value.trim().toLowerCase(),
        solutionImageUrl: document.getElementById("filterSolutionImage").value.trim().toLowerCase(),
        subject: document.getElementById("filterSubject").value.trim().toLowerCase(),
        examTaskNumber: document.getElementById("filterExamNumber").value.trim().toLowerCase(),
        variant: document.getElementById("filterVariant").value.trim().toLowerCase(),
        subtopic: document.getElementById("filterSubtopic").value.trim().toLowerCase(),
        examType: document.getElementById("filterExamType").value.trim().toLowerCase(),
        answer: document.getElementById("filterAnswer").value.trim().toLowerCase(),
        solution: document.getElementById("filterSolution").value.trim().toLowerCase()
      };

      return items.filter((task) => {
        if (filters.id && !String(task.id ?? "").toLowerCase().includes(filters.id)) return false;
        if (filters.question && !String(task.question ?? "").toLowerCase().includes(filters.question)) return false;
        if (filters.imageUrl && !String(task.imageUrl ?? "").toLowerCase().includes(filters.imageUrl)) return false;
        if (filters.solutionImageUrl && !String(task.solutionImageUrl ?? "").toLowerCase().includes(filters.solutionImageUrl)) return false;
        if (filters.subject && !String(task.subject ?? "").toLowerCase().includes(filters.subject)) return false;
        if (filters.examTaskNumber && !String(task.examTaskNumber ?? "").toLowerCase().includes(filters.examTaskNumber)) return false;
        if (filters.variant && !String(task.variant ?? "").toLowerCase().includes(filters.variant)) return false;
        if (filters.subtopic && !String(task.subtopic ?? "").toLowerCase().includes(filters.subtopic)) return false;
        if (filters.examType && !String(task.examType ?? "").toLowerCase().includes(filters.examType)) return false;
        if (filters.answer && !String(task.answer ?? "").toLowerCase().includes(filters.answer)) return false;
        if (filters.solution && !String(task.solution ?? "").toLowerCase().includes(filters.solution)) return false;
        return true;
      });
    }

    function renderSubjectOptions(current) {
      const options = [];
      options.push(`<option value="">Выбрать</option>`);
      subjectOptions.forEach((subject) => {
        const selected = subject === current ? " selected" : "";
        options.push(`<option value="${escapeHtml(subject)}"${selected}>${escapeHtml(subject)}</option>`);
      });
      return options.join("");
    }

    function escapeHtml(value) {
      return String(value)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    function openEditor(event) {
      event.preventDefault();
      activeEditorField = event.target;
      const field = activeEditorField.getAttribute("data-field");
      document.getElementById("editorTitle").innerText =
        field === "question" ? "Редактирование вопроса" : "Редактирование решения";
      document.getElementById("editorTextarea").value = activeEditorField.value;
      document.getElementById("editorBackdrop").classList.remove("hidden");
    }

    function closeEditor() {
      document.getElementById("editorBackdrop").classList.add("hidden");
      activeEditorField = null;
    }

    function saveEditor() {
      if (activeEditorField) {
        activeEditorField.value = document.getElementById("editorTextarea").value;
      }
      closeEditor();
    }

    function collectTasks() {
      const body = document.getElementById("tasksBody");
      const rows = Array.from(body.querySelectorAll("tr"));
      return rows.map((row) => {
        const get = (field) => row.querySelector(`[data-field="${field}"]`);
        return {
          id: Number(get("id").value),
          question: get("question").value.trim(),
          imageUrl: get("imageUrl").value.trim(),
          solutionImageUrl: get("solutionImageUrl").value.trim(),
          subject: get("subject").value.trim(),
          examTaskNumber: Number(get("examTaskNumber").value),
          variant: Number(get("variant").value),
          subtopic: get("subtopic").value.trim(),
          examType: get("examType").value.trim(),
          answer: get("answer").value.trim(),
          solution: get("solution").value.trim()
        };
      });
    }

    async function saveTasks() {
      const payload = collectTasks();
      setStatus("Сохранение...");
      const res = await fetch("/api/tasks", {
        method: "PUT",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload)
      });
      if (!res.ok) {
        const text = await res.text();
        setStatus("Ошибка: " + text);
        return;
      }
      setStatus("Сохранено");
    }

    function addTask() {
      const maxId = tasks.reduce((max, task) => Math.max(max, Number(task.id) || 0), 0);
      tasks.push({
        id: maxId + 1,
        question: "",
        imageUrl: "",
        solutionImageUrl: "",
        subject: "",
        examTaskNumber: 1,
        variant: 0,
        subtopic: "",
        examType: "ЕГЭ",
        answer: 0,
        solution: ""
      });
      renderTable();
    }

    function removeTask(taskId) {
      const originalIndex = tasks.findIndex((item) => item.id === taskId);
      if (originalIndex === -1) return;
      tasks.splice(originalIndex, 1);
      renderTable();
    }

    function triggerUpload(taskId, fieldName) {
      const input = document.querySelector(`[data-upload-id="${taskId}"][data-upload-field="${fieldName}"]`);
      if (input) input.click();
    }

    async function handleUpload(event) {
      const file = event.target.files[0];
      const taskId = Number(event.target.getAttribute("data-upload-id"));
      const fieldName = event.target.getAttribute("data-upload-field") || "imageUrl";
      if (!file || !taskId) return;
      setStatus("Загрузка картинки...");
      const formData = new FormData();
      formData.append("file", file);
      try {
        const res = await fetch("/api/upload", {
          method: "POST",
          body: formData
        });
        if (!res.ok) {
          setStatus("Ошибка загрузки");
          return;
        }
        const data = await res.json();
        const field = document.querySelector(`[data-field="${fieldName}"][data-id="${taskId}"]`);
        if (field && data.url) {
          field.value = data.url;
          setStatus("Картинка загружена. Нажмите «Сохранить»");
        }
      } finally {
        event.target.value = "";
      }
    }

    function normalizeImportedPayload(payload) {
      if (Array.isArray(payload)) return payload;
      if (payload && Array.isArray(payload.tasks)) return payload.tasks;
      return null;
    }

    function buildTaskFromImport(item, index, defaults) {
      const rawExamTask = item.examTaskNumber ?? item.number ?? "";
      const rawVariant = item.variant ?? item.variantNumber ?? "";
      const rawAnswer = item.answer;
      return {
        id: Number(item.id ?? item.number ?? index + 1) || 0,
        question: String(item.question ?? "").trim(),
        imageUrl: String(item.imageUrl ?? "").trim(),
        solutionImageUrl: String(item.solutionImageUrl ?? "").trim(),
        subject: String(item.subject ?? defaults.subject ?? "").trim(),
        examTaskNumber: Number(rawExamTask) || 0,
        variant: Number(rawVariant || defaults.variant || "") || 0,
        subtopic: String(item.subtopic ?? defaults.subtopic ?? "").trim(),
        examType: String(item.examType ?? defaults.examType ?? "").trim(),
        answer: rawAnswer == null ? "" : String(rawAnswer).trim(),
        solution: String(item.solution ?? "").trim()
      };
    }

    document.getElementById("importFile").addEventListener("change", (event) => {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const parsed = JSON.parse(String(reader.result));
          const rawTasks = normalizeImportedPayload(parsed);
          if (!rawTasks || !rawTasks.every((item) => typeof item === "object" && item !== null)) {
            setStatus("Неверный формат файла");
            return;
          }
          const mapped = rawTasks.map((item, index) => buildTaskFromImport(item, index, {}));
          const maxId = tasks.reduce((max, task) => Math.max(max, Number(task.id) || 0), 0);
          mapped.forEach((item, idx) => {
            item.id = maxId + idx + 1;
          });
          tasks = tasks.concat(mapped);
          renderTable();
          setStatus("Добавлено. Нажмите «Сохранить»");
        } catch (error) {
          setStatus("Ошибка чтения JSON");
        } finally {
          event.target.value = "";
        }
      };
      reader.readAsText(file);
    });

    document.getElementById("editorCancel").addEventListener("click", closeEditor);
    document.getElementById("editorSave").addEventListener("click", saveEditor);
    document.getElementById("editorBackdrop").addEventListener("click", (event) => {
      if (event.target.id === "editorBackdrop") closeEditor();
    });
    document.getElementById("editorTextarea").addEventListener("keydown", (event) => {
      if (event.key === "Escape") closeEditor();
      if ((event.ctrlKey || event.metaKey) && event.key === "Enter") saveEditor();
    });

    loadTasks();
  </script>
</body>
</html>
